{"version":3,"file":"ldevice.js","sources":["../../../wizards/ldevice.ts"],"sourcesContent":["import { html, TemplateResult } from 'lit';\n\nimport { EditV2 } from '@openscd/oscd-api';\n\nimport { getReference } from '@openscd/scl-lib';\n\nimport {\n  createElement,\n  getValue,\n  Wizard,\n  WizardActor,\n  WizardInputElement,\n} from '../foundation.js';\nimport { patterns } from './patterns.js';\nimport { SclTextField } from '@openenergytools/scl-text-field';\n\nexport function lDeviceNamePattern(): string {\n  return (\n    '[A-Za-z][0-9A-Za-z_]{0,2}|' +\n    '[A-Za-z][0-9A-Za-z_]{4,63}|' +\n    '[A-MO-Za-z][0-9A-Za-z_]{3}|' +\n    'N[0-9A-Za-np-z_][0-9A-Za-z_]{2}|' +\n    'No[0-9A-Za-mo-z_][0-9A-Za-z_]|' +\n    'Non[0-9A-Za-df-z_]'\n  );\n}\n\nfunction ldNameIsAllowed(element: Element): boolean {\n  return !!element.closest('IED')?.querySelector('Services > ConfLdName');\n}\n\nfunction reservedInstLDevice(currentElement: Element): string[] {\n  const ied = currentElement.closest('IED');\n  if (!ied) {\n    return [];\n  }\n\n  return Array.from(\n    ied.querySelectorAll(':scope > AccessPoint > Server > LDevice'),\n  )\n    .map(ld => ld.getAttribute('inst') ?? '')\n    .filter(name => name !== currentElement.getAttribute('inst'));\n}\n\nfunction render(\n  inst: string | null,\n  ldName: string | null,\n  desc: string | null,\n  reservedInsts: string[],\n  allowLdName: boolean,\n  disableInst: boolean,\n): TemplateResult[] {\n  const content = [\n    allowLdName\n      ? html`<scl-text-field\n          label=\"ldName\"\n          .value=${ldName}\n          nullable\n          supportingText=\"Logical device name\"\n          validationMessage=\"Required\"\n          dialogInitialFocus\n          pattern=\"${lDeviceNamePattern()}\"\n        ></scl-text-field>`\n      : html`<scl-text-field\n          label=\"ldName\"\n          .value=${ldName}\n          supportingText=\"IED doesn't support Functional Naming\"\n          helperPersistent\n          readOnly\n          disabled\n        ></scl-text-field>`,\n    html`<scl-text-field\n      label=\"desc\"\n      .value=${desc}\n      nullable\n      supportingText=\"Logical device description\"\n      pattern=\"${patterns.normalizedString}\"\n    ></scl-text-field>`,\n    html`<scl-text-field\n      label=\"inst\"\n      .value=${inst}\n      ?disabled=${disableInst}\n      required\n      supportingText=\"Logical device inst\"\n      pattern=\"${patterns.normalizedString}\"\n      @input=${(e: Event) => {\n        const input = e.target as SclTextField;\n        const currentValue = getValue(input) ?? '';\n        let customValidityMsg = '';\n        if (reservedInsts.includes(currentValue)) {\n          customValidityMsg = `\"${currentValue}\" is already in use`;\n        }\n        input.setCustomValidity(customValidityMsg);\n        input.reportValidity();\n      }}\n      .reservedValues=${reservedInsts}\n    ></scl-text-field>`,\n  ];\n  return content;\n}\n\nexport function createAction(parent: Element): WizardActor {\n  return (inputs: WizardInputElement[]): EditV2[] => {\n    const inst = getValue(inputs.find(i => i.label === 'inst')!)!;\n    const ldNameAllowed = ldNameIsAllowed(parent);\n    const ldName = ldNameAllowed\n      ? getValue(inputs.find(i => i.label === 'ldName')!)\n      : null;\n    const desc = getValue(inputs.find(i => i.label === 'desc')!);\n    const node = createElement(parent.ownerDocument, 'LDevice', {\n      inst,\n      ldName,\n      desc,\n    });\n\n    return [\n      {\n        parent,\n        node,\n        reference: getReference(parent, 'LDevice'),\n      },\n    ];\n  };\n}\n\nexport function updateAction(element: Element): WizardActor {\n  return (inputs: WizardInputElement[]): EditV2[] => {\n    const ldNameAllowed = ldNameIsAllowed(element);\n    const ldName = ldNameAllowed\n      ? getValue(inputs.find(i => i.label === 'ldName')!)\n      : null;\n\n    if (!ldNameAllowed || ldName === element.getAttribute('ldName')) {\n      return [];\n    }\n\n    return [\n      {\n        element,\n        attributes: { ldName },\n      },\n    ];\n  };\n}\n\nexport function createLDeviceWizard(parent: Element): Wizard {\n  return {\n    title: 'Add LDevice',\n    primary: {\n      icon: '',\n      label: 'save',\n      action: createAction(parent),\n    },\n    content: render(\n      null,\n      null,\n      null,\n      reservedInstLDevice(parent),\n      ldNameIsAllowed(parent),\n      false,\n    ),\n  };\n}\n\nexport function editLDeviceWizard(element: Element): Wizard {\n  return {\n    title: 'Edit LDevice',\n    primary: {\n      icon: 'edit',\n      label: 'save',\n      action: updateAction(element),\n    },\n    content: render(\n      element.getAttribute('inst'),\n      element.getAttribute('ldName'),\n      element.getAttribute('desc'),\n      reservedInstLDevice(element),\n      ldNameIsAllowed(element),\n      true,\n    ),\n  };\n}\n"],"names":["html"],"mappings":"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"}